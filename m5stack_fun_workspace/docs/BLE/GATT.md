# Общий профиль аттрибутов (General Attribute Profile, GATT)

Иерархия представления данных, предоставляемых сервером:

- Сервисы
- Характеристики
- Профили

`Характеристики` - самые низкоуровненвые атрибуты в базе данных аттрибутов.  
`Сервисы` - служат для группировки характеристик по функциональному признаку.  

`GATT` определяет формат сервисов и их характеристик, а также процедуры, используемые  
для взаимодействия с этими аттрибутами, такие как, `обнаружение сервисов`, `чтение и запись характеристик`, `уведомления` и `индикации`.
`GATT` выполняет ту же роль, что и протокол атрибутов `АТТ`. Роли устанавливаются не для устройств, они определяются во время транзакций.  
(такие как запрос ⟷ ответ, индикация ⟷ подтверждение, уведомление).  
Таким образом, устройство может действовать как `сервер`, предоставляющий данные клиентам, и в то же время быть в роли `клиента`, получая данные, подготовленные другими серверами одновременно

## Сервисы и характеристики

### Сервисы

Сервисы это группа из одного или большего числа атрибутов, некоторые из которых являются характеристиками.  
Он предназначен для группировки связанных атрибутов, удовлетворяющих специфической функциональности сервера.  
Например, одобренный `SIG` сервис батареи содержит одну характеристику под названием `уровень заряда`.  
Сервисы также содержат другие атрибуты, которые помогают структурировать данные сервиса, такие как объявления сервера, объявления характеристик и другие.  

[Services](/docs/BLE/Services.png)

### Характеристики

Характеристика всегда является частью сервиса и предоставляет часть тех данных, которые сервер хочет предоставить клиенту.  
Например, характеристика уровня заряда батареи показывает оставшийся уровень заряда батареи в устройстве, который может быть прочитан клиентом.  
Характеристика содержит набор атрибутов, которые облегчают работу с содержащимися в характеристике данными:

- `Свойства`: представлены набором бит, определяющих то, каким образом значение характеристики может использоваться.  
Пример свойств: чтение, запись, запись без ответа, уведомление, индикация.  
- `Дескрипторы`: используются для хранения информации, связанной со значением характеристики.  
Примеры использования: расширенные свойства, пользовательское описание, поля, используемые для подписки на уведомления  
и индикации, поля, описывающие представление характеристики, такие как формат или единица измерения.

[Список одобренных SIG сервисов](https://www.bluetooth.com/specifications/assigned-numbers/)

## Профили

Профили занимаются определением поведения, как клинента, так и сервиса, когда дело касается сервисов, характеристик,  
соединений и требований безопасности. Сервисы и их спецификации, с другой стороны, касаются реализации этих сервисов и характеристик **только на стороне сервера**.  

Существуют одобренные `SIG` профили с опубликованными спецификациями к ним. Содержимое спецификаций:

- Определение ролей и взаимоотношений между `GATT` сервера и клиента
- Требуемые сервисы
- Требования сервисов
- Как используются требуемые сервисы и характеристики
- Детали требований к процессу установления соединения, включая параметры адвертайзинга и соединения
- Соображения безопасности

![Спецификация на профиль кровяного давленияs](/docs/BLE/Profile.png)

## Пример GATT

```xml
<?xml version="1.0" encoding="UTF-8" ?>
<configuration> 
    <service uuid="1800">
        <description>Generic Access Profile</description>

        <characteristic uuid="2a00"> 
            <properties read="true" const="true" />
            <value>Bluegiga CR Demo</value>
        </characteristic>

        <characteristic uuid="2a01"> 
            <properties read="true" const="true" />
            <value type="hex">4142</value>
        </characteristic>
    </service>

    <service uuid="0bd51666-e7cb-469b-8e4d-2742f1ba77cc" advertise="true"> 
        <description>Cable replacement service</description>

        <characteristic uuid="e7add780-b042-4876-aae1-112855353cc1" id="xgatt_data">
            <description>Data</description> 
            <properties write="true" indicate="true" />
            <value variable_length="true" length="20" type="user" />
        </characteristic>
    </service>

</configuration>
```

Определены два сервиса:

- Сервис общего профиля доступа (GAP) с UUID: `0x1800` (одобрен SIG).
- Сервис замены кабеля с UUID: `0bd51666-e7cb-469b-8e4d-2742f1ba77cc` (Собственный сервис, определенный разработчиком приложения или производителем чипсета)

Сервис `общего профиля доступа` обязателен по спецификации и включает следующие обязательные характеристики:

- Имя с UUID `0x2A00` и значением: `Bluegiga CR Demo`.
- Окружение с UUID `0x2A01` и значением `0x4142`.

Сервис `замены кабеля` имеет одну характеристику под названием `данные`:

- Характеристика данных имеет UUID: `e7add780-b042-4876-aae1-112855353cc1`
- Включены свойства, разрешающие запись в характеристику и индикацию.



## Операции с атрибутами

### Типы операция

- `Команды` - посылаются клиентом серверу и **не требуют ответов**
- `Запросы` - посылаются клиентом серверу и **требуют ответа** (Запросы на поиск информации и запросы на чтение)
- `Ответы` - посылаются сервером клиенту в ответ на запрос
- `Уведомления` - посылаются сервером клиенту с целью оповестить об изменеии значения характеристики. Для получения уведомлений  
клиент долже включить их для интересующих характеристик (**не требуют подтверждения** получения от клиента)  
- `Индикации` - посылаются сервером клиенту, **требуют подтверждения** получения от клиента
- `Подтверждения` - посылаются клиентом серверу. Отправляются с целью уведомить сервер об успешном приеме `индикации` клиентом.

### Управление потоком и последовательность операций с атрибутами

`Запросы` последовательны по своей природе и требуют ответа от сервера перед отправкой нового запроса.  
`Индикации` имеют такое же требование: новая индикация не может быть отправлена до тех пор, пока не получено подтверждение о приеме предыдущей индикации.  
`Запросы и индикации` являются взаимоисключающими с точки зрения требований к последовательности, то есть индикация может быть отправлена сервером до того как он ответит на запрос, который получил ранее.  
`Команды и уведомления` отличаются, и не требуют управления потоком сообщений - они могут быть посланы в любое время.  
По этой причине, а также потому что сервер или клиент могут быть не в состоянии обработать эти пакеты, они `считаются ненадежными`.  
`Запросы и индикации` должны использоваться в случаях, когда надежность стоит во главе угла.  

### Чтение атрибутов

`Чтение` - это вид запроса. Существуют типы запросов на чтение:

- `Запрос на чтение`: простой запрос, ссылающийся на атрибут, который будет прочитан его дескриптором
- `Запрос на чтение части данных`: похож на запрос на чтение, но содержит смещение, указывающее, с какого участка чтение должно начаться, возвращая часть значения
  
### Запись атрибутов

`Запись` может быть командой или запросом.

- `Запрос на запись`: требует ответа от сервера, подтверждающего успешное получение данных.
- `Команда на запись`: не требует ответа от сервера
- `Упорядоченная запись` (атомарное поведение операции): классифицируется как запрос и требует подтверждения от сервера

`Упорядоченная запись` используются в случаях, когда требуется записать большое количество данных, не умещающееся в одно сообщение.  
Вместо того, чтобы записывать части сообщения и давать возможность кому-то прочитать некорректное неполное значение,  
применяются два типа запросов на запись, для того, чтобы иметь уверенность в безопасном выполнении операции:

1. `Один или несколько запросов на подготовку к записи`: каждый включает в себя смещение, с которым посылаемое значение должно быть записано в значение атрибута. Посылаемые значения также часто называют подготовленными значениями, и они хранятся в буфере на стороне сервера, еще не записанные в атрибут. Эта операция требует ответа со стороны сервера.
2. `Один запрос на запись`: используется для запроса сервера о выполнении или отмены записи принятых значений в атрибут. Требует ответа от сервера для того, чтобы клиент был уверен в том, что атрибут содержит целое и верное значение, посланное серверу.

### Запрос на обмен MTU

Сервер и клиент согласуют общее значение MTU, использующееся для передачи данных в обоих направлениях.  
Запрос инициируется клиентом и может быть послан только один раз во время жизни соединения.  
Сервер отвечает особым пакетом, содержащим поддерживаемый им размер `ATT_MTU.`  
Итоговое значение будет выбрано равным меньшему из переданных между сервером и клиентом `ATT_MTU`.
Важно помнить, что различные версии BLE имеют разные поддерживаемые максимальные значения `ATT_MTU`.
