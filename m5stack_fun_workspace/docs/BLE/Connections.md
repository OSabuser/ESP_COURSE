# Соединения и сервисы

## Соединения

Для установки соединения между двумя BLE-устройствами, необходимо:

- `Периферийное устройство` должно начать процесс адвертайзинга и не останавливать его до момента установки соединения
- `Центральное устройство` должно сканировать радиоэфир в поисках пакетов адвертайзинга
- Если `центральное устройство` прослушивает канал адвертайзинга в момент, когда `периферийное устройство` посылает по нему данные, то оно обнаруживает `периферийное устройство`
- Затем центральное устройство посылает пакет `COONECT_IND` (запрос на соединение)
- `Периферийное устройство` всегда прослушивает **текущий** канал адвертайзинга после отправки пакета `CONNECT_IND`

После того как будут выполнены эти шаги, соединение будет считаться **созданным**, но еще **не установленным**.  
Соединение будет считаться **установленным**, после того как устройство получит **пакет данных** от своего партнера по соединению.  
После установления соединения `центральное устройство` возьмет на себя роль **ведущего**, а `периферийное`, в свою очередь, **ведомого**.  
**Ведущее устройство** будет отвечать за управление соединением, контроль параметров соединения и контроль временных интервалов между различными событиями.  

### События соединения

Во время `событий подключения` ведущий и ведомый отправляют друг другу данные до тех пор, пока не останеся данных, требующий передачи.  

- `События подключения` происходят периодически до тех пор, пока соединение не будет закрыто или потеряно.
- `Событие подключения` состоит как минимум из одного пакета посланного **ведущим устройством**.
- **Ведомое устройство** всегда отвечает отправкой пакета, если оно получает пакет от **ведущего**.  
- Если **ведущий** не получает ответный пакет от **ведомого**, он закрывает подключение - он возобновит посылку пакетов во время следующего `события подключения`.  
- Подключение может быть закрыто как **ведущим**, так и **ведомым**.
- События подключения разнесены во времени на период `интервала соединения`

![Connection Event](/docs/BLE/connection_event.png)

### Параметры соединения

#### Интервал соединения

> Интервал соединения может принимать любое из значений между **7.5 мс** и **4.0 секундами** с шагом в **1.25 мс**. Он задается `центральным устройством` в пакете `запроса соединения`.  
> `Центральное устройство` может принять во внимание `Предпочитаемые Параметры Соединения Периферийного Устройства` (PPCP).
> `Центральное устройство` вправе принять их, модифицировать или отклонить.

#### Задержка ведомого (Slave Latency)

> Параметр задержки ведомого позволяет `периферийному устройству` оставлять без ответа определенное количество событий.  
> соединения и не слушать `центральное устройство` во время этих событий без инвалидации соединения.  
> Это позволяет `периферийному устройству` переходить в режим энергосбережения на более длительный срок.  
> `Задержка ведомого` отображает количество событий соединения, которое `периферийное устройство` может пропустить.

Например, если установлена задержка три, то периферийное устройство может пропустить три последовательных события соединения,  
но затем оно должно будет выйти из режима энергосбережения, прослушать центральное устройство и ответить на следующее событие соединения.  

#### Таймаут наблюдения (Supervision Timeout)

> Таймаут наблюдения используется для определения потери соединения. Он определяется как максимальное время между двумя полученными пакетами данных,  
> прежде чем соединение считается потерянным. Его значение может задаваться в диапазоне между 100 мс и 32 секундами с шагом 10 мс.

Другое условие выглядит следующим образом:
`Таймаут наблюдения > (1 + задержка ведомого) * интервал соединения * 2`

Существует исключение, для которого `таймаут наблюдения` не применяется - в момент, когда соединение создано, но еще не установлено.  
В этом случае **ведущее устройство** примет решение о потере соединения, если не получит пакета от ведомого в течении **6 интервалов соединения**.  

#### Расширение длины данных (Data Length Extension)

> Это опция, которая позволяет пакетам данных содержать большее количество полезной нагрузки (до **251 байта**, в случае, когда эта настройка выключена,  
> полезная нагрузка составляет **27 байт**). Эта возможность введена в версии 4.2 спецификации Bluetooth.

#### Максимальная единица передачи (MTU)

> Понятие максимальной единицы передачи используется в компьютерных сетях и определяет максимальный размер данных,  
> которые можно передать по определенному протоколу. Максимальная единица передачи атрибута (в спецификации определена как ATT_MTU)
> это наибольший размер полезной нагрузки атрибута, который можно передать между клиентом и сервером.

Эффективный размер `ATT_MTU` определяется наименьшим значением максимальных `ATT_MTU` поддерживаемых ведущим и ведомым.  
Например, если ведущее устройство поддерживает `ATT_MTU` **100 байт** и ведомое устройство сообщает, что оно поддерживает `ATT_MTU` **150 байт**,  
то ведущий решает, что для этого соединения будет использоваться `ATT_MTU` **100 байт**.
